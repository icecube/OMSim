<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" class="light-mode">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.9.8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>OMSim: Multi-threading mode</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link rel="icon" type="image/svg+xml" href="logo.drawio.svg"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="doxygen-awesome-darkmode-toggle.js"></script>
<script type="text/javascript" src="doxygen-awesome-fragment-copy-button.js"></script>
<script type="text/javascript" src="doxygen-awesome-paragraph-link.js"></script>
<script type="text/javascript" src="doxygen-awesome-interactive-toc.js"></script>
<script type="text/javascript" src="doxygen-awesome-tabs.js"></script>
<script type="text/javascript" src="toggle-alternative-theme.js"></script>
<script type="text/javascript">
    DoxygenAwesomeFragmentCopyButton.init()
    DoxygenAwesomeDarkModeToggle.init()
    DoxygenAwesomeParagraphLink.init()
    DoxygenAwesomeInteractiveToc.init()
    DoxygenAwesomeTabs.init()
</script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  extensions: ["tex2jax.js"],
  jax: ["input/TeX","output/HTML-CSS"],
});
</script>
<script type="text/javascript" async="async" src="https://cdn.jsdelivr.net/npm/mathjax@2/MathJax.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="doxygen-awesome.css" rel="stylesheet" type="text/css"/>
<link href="custom.css" rel="stylesheet" type="text/css"/>
<link href="doxygen-awesome-sidebar-only.css" rel="stylesheet" type="text/css"/>
<link href="custom-alternative.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- https://tholman.com/github-corners/ -->
<a href="https://github.com/icecube/OMSim" class="github-corner" title="View source on GitHub" target="_blank">
    <svg viewBox="0 0 250 250" width="40" height="40" style="position: absolute; top: 0; border: 0; right: 0; z-index: 99;" aria-hidden="true">
    <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a><style>.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}</style>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="logotest.png"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">OMSim
   </div>
   <div id="projectbrief">Geant4 for IceCube optical module studies</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.8 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('md_extra__doc_21__multithreading.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">Multi-threading mode</div></div>
</div><!--header-->
<div class="contents">
<div class="toc"><h3>Table of Contents</h3>
<ul><li class="level1"><a href="#autotoc_md19">Introduction</a></li>
<li class="level1"><a href="#autotoc_md20">Thread Safety Guidelines</a></li>
<li class="level1"><a href="#autotoc_md21">Thread-Safe Global Instance Implementation</a><ul><li class="level2"><a href="#autotoc_md22">Example: OMSimHitManager</a></li>
<li class="level2"><a href="#autotoc_md23">Example: Saving Data Per Thread</a></li>
</ul>
</li>
<li class="level1"><a href="#autotoc_md24">Best Practices for Creating New Thread-Safe Containers</a></li>
<li class="level1"><a href="#autotoc_md25">Troubleshooting Multi-threading Issues</a><ul><li class="level2"><a href="#autotoc_md26">1. Use Valgrind Tools</a></li>
<li class="level2"><a href="#autotoc_md27">2. Analyse the Output</a></li>
<li class="level2"><a href="#autotoc_md28">4. Modify and repeat</a></li>
</ul>
</li>
</ul>
</div>
<div class="textblock"><p><a class="anchor" id="autotoc_md18"></a></p>
<p>The OMSim-Framework allows for multi-threading. The number of threads can be controlled with the <code>--threads</code> argument (default 1). If you specify more threads than available, only the maximum available will be used.</p>
<h1><a class="anchor" id="autotoc_md19"></a>
Introduction</h1>
<p>Geant4 implements multi-threading using a master-worker model:</p>
<ol type="1">
<li><b>Master Thread</b>: Responsible for initialization, geometry construction, and coordinating worker threads.</li>
<li><b>Worker Threads</b>: Each simulates complete events independently.</li>
</ol>
<p>Key points:</p><ul>
<li>Geometry and physics tables are shared read-only among threads.</li>
<li>Each thread has its own instance of sensitive detectors, event and tracking managers.</li>
<li>Random number generators are designed to produce independent streams for each thread.</li>
</ul>
<h1><a class="anchor" id="autotoc_md20"></a>
Thread Safety Guidelines</h1>
<ol type="1">
<li><b>Use Thread-Local Storage</b>: For data unique to each thread, use <code>G4ThreadLocal</code>.</li>
<li><b>Protect Shared Resources</b>: Use mutex locks when accessing shared resources.</li>
<li><b>Minimize Global Variables</b>: Prefer class members or local variables instead.</li>
<li><b>Implement Thread-Safe Containers</b>: Ensure thread-safe access and modification of containers.</li>
</ol>
<h1><a class="anchor" id="autotoc_md21"></a>
Thread-Safe Global Instance Implementation</h1>
<p>Both <code><a class="el" href="class_o_m_sim_hit_manager.html" title="Manages detected photon information.">OMSimHitManager</a></code> and <code><a class="el" href="class_o_m_sim_decays_analysis.html" title="Singleton class responsible for managing, analysing, and saving decay-related data.">OMSimDecaysAnalysis</a></code> utilize a global instance pattern. This approach provides better control over the lifecycle of the instance and can prevent potential memory leaks when integrated into larger frameworks. The process works as follows:</p>
<ol type="1">
<li>Initialize the global instance explicitly at the start of the program. This is means, before the multi-threading starts.</li>
<li>Access the instance through a global pointer.</li>
<li>Shut down and clean up the instance explicitly at the end of the program.</li>
</ol>
<p>Implementation of the global instance pattern:</p>
<div class="fragment"><div class="line"><span class="comment">// In the header file</span></div>
<div class="line"><span class="keyword">class </span><a class="code hl_class" href="class_o_m_sim_hit_manager.html">OMSimHitManager</a></div>
<div class="line">{</div>
<div class="line"><span class="keyword">public</span>:</div>
<div class="line">    <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code hl_function" href="class_o_m_sim_hit_manager.html#ac26f7ad778584ece58f86d60192ef671">init</a>();</div>
<div class="line">    <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code hl_function" href="class_o_m_sim_hit_manager.html#ad8a139a9068c92b7babf471c9ec23ecf">shutdown</a>();</div>
<div class="line">    <span class="keyword">static</span> <a class="code hl_class" href="class_o_m_sim_hit_manager.html">OMSimHitManager</a>&amp; <a class="code hl_function" href="class_o_m_sim_hit_manager.html#aaa3e7a28d658d8e2e6db704b910cc35c">getInstance</a>();</div>
<div class="line">    <span class="comment">// ... other methods ...</span></div>
<div class="line"> </div>
<div class="line"><span class="keyword">private</span>:</div>
<div class="line">    <span class="comment">// ... other members ...</span></div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line"><span class="keyword">inline</span> <a class="code hl_class" href="class_o_m_sim_hit_manager.html">OMSimHitManager</a>* g_hitManager = <span class="keyword">nullptr</span>;</div>
<div class="line"> </div>
<div class="line"><span class="comment">// In the source file</span></div>
<div class="line"><span class="keywordtype">void</span> <a class="code hl_function" href="class_o_m_sim_hit_manager.html#ac26f7ad778584ece58f86d60192ef671">OMSimHitManager::init</a>()</div>
<div class="line">{</div>
<div class="line">    <span class="keywordflow">if</span> (!g_hitManager) g_hitManager = <span class="keyword">new</span> <a class="code hl_class" href="class_o_m_sim_hit_manager.html">OMSimHitManager</a>();</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">void</span> <a class="code hl_function" href="class_o_m_sim_hit_manager.html#ad8a139a9068c92b7babf471c9ec23ecf">OMSimHitManager::shutdown</a>()</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">delete</span> g_hitManager;</div>
<div class="line">    g_hitManager = <span class="keyword">nullptr</span>;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><a class="code hl_class" href="class_o_m_sim_hit_manager.html">OMSimHitManager</a>&amp; <a class="code hl_function" href="class_o_m_sim_hit_manager.html#aaa3e7a28d658d8e2e6db704b910cc35c">OMSimHitManager::getInstance</a>()</div>
<div class="line">{</div>
<div class="line">    assert(g_hitManager);</div>
<div class="line">    <span class="keywordflow">return</span> *g_hitManager;</div>
<div class="line">}</div>
<div class="ttc" id="aclass_o_m_sim_hit_manager_html"><div class="ttname"><a href="class_o_m_sim_hit_manager.html">OMSimHitManager</a></div><div class="ttdoc">Manages detected photon information.</div><div class="ttdef"><b>Definition</b> OMSimHitManager.hh:56</div></div>
<div class="ttc" id="aclass_o_m_sim_hit_manager_html_aaa3e7a28d658d8e2e6db704b910cc35c"><div class="ttname"><a href="class_o_m_sim_hit_manager.html#aaa3e7a28d658d8e2e6db704b910cc35c">OMSimHitManager::getInstance</a></div><div class="ttdeci">static OMSimHitManager &amp; getInstance()</div><div class="ttdef"><b>Definition</b> OMSimHitManager.cc:44</div></div>
<div class="ttc" id="aclass_o_m_sim_hit_manager_html_ac26f7ad778584ece58f86d60192ef671"><div class="ttname"><a href="class_o_m_sim_hit_manager.html#ac26f7ad778584ece58f86d60192ef671">OMSimHitManager::init</a></div><div class="ttdeci">static void init()</div><div class="ttdoc">Initializes the global instance of OMSimHitManager.</div><div class="ttdef"><b>Definition</b> OMSimHitManager.cc:23</div></div>
<div class="ttc" id="aclass_o_m_sim_hit_manager_html_ad8a139a9068c92b7babf471c9ec23ecf"><div class="ttname"><a href="class_o_m_sim_hit_manager.html#ad8a139a9068c92b7babf471c9ec23ecf">OMSimHitManager::shutdown</a></div><div class="ttdeci">static void shutdown()</div><div class="ttdoc">Deletes the global instance of OMSimHitManager.</div><div class="ttdef"><b>Definition</b> OMSimHitManager.cc:33</div></div>
</div><!-- fragment --><blockquote class="doxtable">
<p>&zwj;<b>Note</b>: While this global instance implementation provides better control over the instance lifecycle, it requires explicit initialization and shutdown. Ensure these are called at appropriate times (single-thread) in your application (for example in main before/after run). </p>
</blockquote>
<h2><a class="anchor" id="autotoc_md22"></a>
Example: OMSimHitManager</h2>
<p>The <code><a class="el" href="class_o_m_sim_hit_manager.html" title="Manages detected photon information.">OMSimHitManager</a></code> class demonstrates several thread-safety techniques for saving data:</p>
<div class="fragment"><div class="line"><span class="keyword">class </span><a class="code hl_class" href="class_o_m_sim_hit_manager.html">OMSimHitManager</a></div>
<div class="line">{</div>
<div class="line"><span class="keyword">public</span>:</div>
<div class="line">    <span class="keywordtype">void</span> <a class="code hl_function" href="class_o_m_sim_hit_manager.html#aaf4ca3c29c6dbe8721aaafd4fd39d436">appendHitInfo</a>(<span class="comment">/* parameters */</span>);</div>
<div class="line">    <span class="keywordtype">void</span> mergeThreadData();</div>
<div class="line">    <span class="comment">// ... other methods ...</span></div>
<div class="line"> </div>
<div class="line"><span class="keyword">private</span>:</div>
<div class="line">    <span class="keyword">static</span> G4Mutex m_mutex;  <span class="comment">// Mutex for thread synchronization</span></div>
<div class="line"> </div>
<div class="line">    <span class="keyword">struct </span>ThreadLocalData {</div>
<div class="line">        std::map&lt;G4int, HitStats&gt; moduleHits;</div>
<div class="line">    };</div>
<div class="line">    <span class="comment">// Thread-local storage for hit data</span></div>
<div class="line">    G4ThreadLocal <span class="keyword">static</span> ThreadLocalData* m_threadData;</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// ... </span></div>
<div class="line">};</div>
<div class="ttc" id="aclass_o_m_sim_hit_manager_html_aaf4ca3c29c6dbe8721aaafd4fd39d436"><div class="ttname"><a href="class_o_m_sim_hit_manager.html#aaf4ca3c29c6dbe8721aaafd4fd39d436">OMSimHitManager::appendHitInfo</a></div><div class="ttdeci">void appendHitInfo(G4int p_eventid, G4double pGlobalTime, G4double pLocalTime, G4double pTrackLength, G4double pEnergy, G4int pPMTHitNumber, G4ThreeVector pMomentumDirection, G4ThreeVector pGlobalPos, G4ThreeVector pLocalPos, G4double pDistance, OMSimPMTResponse::PMTPulse pResponse, G4int pModuleIndex=0)</div><div class="ttdoc">Appends hit information for a detected photon to the corresponding module's hit data.</div><div class="ttdef"><b>Definition</b> OMSimHitManager.cc:99</div></div>
</div><!-- fragment --><p>Key features:</p><ul>
<li>Thread-local storage for hit data (<code>m_threadData</code>), each thread will start one</li>
<li>Mutex (<code>m_mutex</code>) for thread synchronization.</li>
</ul>
<p>The <code>appendHitInfo</code> method is used by all threads and uses to the thread-local <code>m_threadData</code>:</p>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> <a class="code hl_function" href="class_o_m_sim_hit_manager.html#aaf4ca3c29c6dbe8721aaafd4fd39d436">OMSimHitManager::appendHitInfo</a>(<span class="comment">/* parameters */</span>)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordflow">if</span> (!m_threadData)</div>
<div class="line">    {</div>
<div class="line">        <span class="comment">// Initialize thread-local data on first use</span></div>
<div class="line">        m_threadData = <span class="keyword">new</span> ThreadLocalData();</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">auto</span> &amp;moduleHits = m_threadData-&gt;moduleHits[p_moduleNumber];</div>
<div class="line">    G4int eventID = G4EventManager::GetEventManager()-&gt;GetConstCurrentEvent()-&gt;GetEventID();</div>
<div class="line">    moduleHits.eventId.push_back(eventID);</div>
<div class="line">    <span class="comment">//...</span></div>
<div class="line">}</div>
</div><!-- fragment --><p>The <code>mergeThreadData</code> method combines data from all threads into a single vector:</p>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> OMSimHitManager::mergeThreadData()</div>
<div class="line">{</div>
<div class="line">    G4AutoLock lock(&amp;m_mutex);  <span class="comment">// Ensure thread-safe access to shared data</span></div>
<div class="line">    <span class="keywordflow">if</span> (m_threadData)</div>
<div class="line">    {</div>
<div class="line">        <span class="comment">// Merge thread-local data into a single container</span></div>
<div class="line">        <span class="comment">// This is where data from all threads is combined</span></div>
<div class="line">        <span class="comment">// ...</span></div>
<div class="line"> </div>
<div class="line">        <span class="comment">// Clean up thread-local data after merging</span></div>
<div class="line">        <span class="keyword">delete</span> m_threadData;</div>
<div class="line">        m_threadData = <span class="keyword">nullptr</span>;</div>
<div class="line">    }</div>
<div class="line">}</div>
</div><!-- fragment --><blockquote class="doxtable">
<p>&zwj;<b>Important</b>: Call <code>mergeThreadData</code> after all threads have finished simulating (after a run has completed). </p>
</blockquote>
<h2><a class="anchor" id="autotoc_md23"></a>
Example: Saving Data Per Thread</h2>
<p>In scenarios where merging data is unnecessary, or the amount of data is too large to wait until end of run, each thread can save its data in separate files. This is demonstrated in the <code><a class="el" href="class_o_m_sim_decays_analysis.html" title="Singleton class responsible for managing, analysing, and saving decay-related data.">OMSimDecaysAnalysis</a></code> class.</p>
<ol type="1">
<li><b>appendDecay</b>: Collects decay data for each thread.</li>
</ol>
<div class="fragment"><div class="line"><span class="comment">//from radioactive_decays/src/OMSimDecaysAnalysis.cc</span></div>
<div class="line"><span class="keywordtype">void</span> <a class="code hl_function" href="class_o_m_sim_decays_analysis.html#a35aa71b0f55694ab682eb12e33e773d3">OMSimDecaysAnalysis::appendDecay</a>(G4String pParticleName, G4double pDecayTime, G4ThreeVector pDecayPosition)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordflow">if</span> (!m_threadDecayStats)</div>
<div class="line">    {</div>
<div class="line">        m_threadDecayStats = <span class="keyword">new</span> <a class="code hl_struct" href="struct_decay_stats.html">DecayStats</a>();</div>
<div class="line">    }</div>
<div class="line">    G4int lEventID = G4EventManager::GetEventManager()-&gt;GetConstCurrentEvent()-&gt;GetEventID();</div>
<div class="line">    m_threadDecayStats-&gt;<a class="code hl_variable" href="struct_decay_stats.html#a7cead323e226455fe4c847ff5043bd20">eventId</a>.push_back(lEventID);</div>
<div class="line">    (...)</div>
<div class="line">}</div>
<div class="ttc" id="aclass_o_m_sim_decays_analysis_html_a35aa71b0f55694ab682eb12e33e773d3"><div class="ttname"><a href="class_o_m_sim_decays_analysis.html#a35aa71b0f55694ab682eb12e33e773d3">OMSimDecaysAnalysis::appendDecay</a></div><div class="ttdeci">void appendDecay(G4String pParticleName, G4double pDecayTime, G4ThreeVector pDecayPosition)</div><div class="ttdoc">Append decay information to internal data structures.</div><div class="ttdef"><b>Definition</b> OMSimDecaysAnalysis.cc:36</div></div>
<div class="ttc" id="astruct_decay_stats_html"><div class="ttname"><a href="struct_decay_stats.html">DecayStats</a></div><div class="ttdoc">A structure to store information about decays.</div><div class="ttdef"><b>Definition</b> OMSimDecaysAnalysis.hh:17</div></div>
<div class="ttc" id="astruct_decay_stats_html_a7cead323e226455fe4c847ff5043bd20"><div class="ttname"><a href="struct_decay_stats.html#a7cead323e226455fe4c847ff5043bd20">DecayStats::eventId</a></div><div class="ttdeci">std::vector&lt; G4long &gt; eventId</div><div class="ttdoc">ID of the event.</div><div class="ttdef"><b>Definition</b> OMSimDecaysAnalysis.hh:18</div></div>
</div><!-- fragment --><ol type="1">
<li><b>writeThreadDecayInformation</b>: Writes decay data to a file specific to each thread.</li>
</ol>
<div class="fragment"><div class="line"><span class="comment">//from radioactive_decays/src/OMSimDecaysAnalysis.cc</span></div>
<div class="line"><span class="keywordtype">void</span> <a class="code hl_function" href="class_o_m_sim_decays_analysis.html#abf3b99f2998f27c9ad1f792dfc716e0c">OMSimDecaysAnalysis::writeThreadDecayInformation</a>()</div>
<div class="line">{</div>
<div class="line">    G4String outputSuffix = <a class="code hl_function" href="class_o_m_sim_command_args_table.html#ac6f8ed95981671d5df9b029bcef93214">OMSimCommandArgsTable::getInstance</a>().<a class="code hl_function" href="class_o_m_sim_command_args_table.html#a6a455736ab058037381fd786c52ca86f">get</a>&lt;std::string&gt;(<span class="stringliteral">&quot;output_file&quot;</span>);</div>
<div class="line">    G4String decaysFileName = outputSuffix + <span class="stringliteral">&quot;_&quot;</span> + <a class="code hl_function" href="namespace_tools.html#aee9fb48a4947040e59508fd02baa6b4f">Tools::getThreadIDStr</a>() + <span class="stringliteral">&quot;_decays.dat&quot;</span>; <span class="comment">// one file per thread, appending thread id to file name</span></div>
<div class="line"> </div>
<div class="line">    std::fstream dataFile;</div>
<div class="line">    dataFile.open(decaysFileName.c_str(), std::ios::out | std::ios::app);</div>
<div class="line">    <span class="keywordflow">if</span> (m_threadDecayStats-&gt;<a class="code hl_variable" href="struct_decay_stats.html#a7cead323e226455fe4c847ff5043bd20">eventId</a>.size() &gt; 0)</div>
<div class="line">    {</div>
<div class="line">        (...)</div>
<div class="line">    }</div>
<div class="line">    dataFile.close();</div>
<div class="line">}</div>
<div class="ttc" id="aclass_o_m_sim_command_args_table_html_a6a455736ab058037381fd786c52ca86f"><div class="ttname"><a href="class_o_m_sim_command_args_table.html#a6a455736ab058037381fd786c52ca86f">OMSimCommandArgsTable::get</a></div><div class="ttdeci">T get(const std::string &amp;p_key)</div><div class="ttdoc">Retrieves a parameter from the table.</div><div class="ttdef"><b>Definition</b> OMSimCommandArgsTable.hh:82</div></div>
<div class="ttc" id="aclass_o_m_sim_command_args_table_html_ac6f8ed95981671d5df9b029bcef93214"><div class="ttname"><a href="class_o_m_sim_command_args_table.html#ac6f8ed95981671d5df9b029bcef93214">OMSimCommandArgsTable::getInstance</a></div><div class="ttdeci">static OMSimCommandArgsTable &amp; getInstance()</div><div class="ttdef"><b>Definition</b> OMSimCommandArgsTable.cc:7</div></div>
<div class="ttc" id="aclass_o_m_sim_decays_analysis_html_abf3b99f2998f27c9ad1f792dfc716e0c"><div class="ttname"><a href="class_o_m_sim_decays_analysis.html#abf3b99f2998f27c9ad1f792dfc716e0c">OMSimDecaysAnalysis::writeThreadDecayInformation</a></div><div class="ttdeci">void writeThreadDecayInformation()</div><div class="ttdoc">Write isotoped related data to the output file.</div><div class="ttdef"><b>Definition</b> OMSimDecaysAnalysis.cc:75</div></div>
<div class="ttc" id="anamespace_tools_html_aee9fb48a4947040e59508fd02baa6b4f"><div class="ttname"><a href="namespace_tools.html#aee9fb48a4947040e59508fd02baa6b4f">Tools::getThreadIDStr</a></div><div class="ttdeci">G4String getThreadIDStr()</div><div class="ttdef"><b>Definition</b> OMSimTools.cc:439</div></div>
</div><!-- fragment --><p>Data is saved after each event in the <code>EndOfEventAction</code> method to handle large volumes of data:</p>
<div class="fragment"><div class="line"><span class="comment">//from radioactive_decays/src/OMSimEventAction.cc</span></div>
<div class="line"><span class="keywordtype">void</span> <a class="code hl_function" href="class_o_m_sim_event_action.html#a10298c7dff0337cec4ee06a25ca9c116">OMSimEventAction::EndOfEventAction</a>(<span class="keyword">const</span> G4Event *p_evt)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordflow">if</span> (!<a class="code hl_function" href="class_o_m_sim_command_args_table.html#ac6f8ed95981671d5df9b029bcef93214">OMSimCommandArgsTable::getInstance</a>().get&lt;bool&gt;(<span class="stringliteral">&quot;multiplicity_study&quot;</span>))</div>
<div class="line">    {</div>
<div class="line">        <a class="code hl_class" href="class_o_m_sim_decays_analysis.html">OMSimDecaysAnalysis</a> &amp;analysisManager = <a class="code hl_function" href="class_o_m_sim_decays_analysis.html#a4aea9bd04b3f168cfcae98808b33f90c">OMSimDecaysAnalysis::getInstance</a>();</div>
<div class="line">        analysisManager.<a class="code hl_function" href="class_o_m_sim_decays_analysis.html#a78449c898f237d5a40c75042123c19af">writeThreadHitInformation</a>();</div>
<div class="line">        analysisManager.<a class="code hl_function" href="class_o_m_sim_decays_analysis.html#abf3b99f2998f27c9ad1f792dfc716e0c">writeThreadDecayInformation</a>();</div>
<div class="line">        analysisManager.<a class="code hl_function" href="class_o_m_sim_decays_analysis.html#aa111935e44e66f005b9b59a3ee5919e0">reset</a>();</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="ttc" id="aclass_o_m_sim_decays_analysis_html"><div class="ttname"><a href="class_o_m_sim_decays_analysis.html">OMSimDecaysAnalysis</a></div><div class="ttdoc">Singleton class responsible for managing, analysing, and saving decay-related data.</div><div class="ttdef"><b>Definition</b> OMSimDecaysAnalysis.hh:29</div></div>
<div class="ttc" id="aclass_o_m_sim_decays_analysis_html_a4aea9bd04b3f168cfcae98808b33f90c"><div class="ttname"><a href="class_o_m_sim_decays_analysis.html#a4aea9bd04b3f168cfcae98808b33f90c">OMSimDecaysAnalysis::getInstance</a></div><div class="ttdeci">static OMSimDecaysAnalysis &amp; getInstance()</div><div class="ttdoc">Returns the instance of OMSimDecaysAnalysis (Singleton pattern).</div><div class="ttdef"><b>Definition</b> OMSimDecaysAnalysis.cc:15</div></div>
<div class="ttc" id="aclass_o_m_sim_decays_analysis_html_a78449c898f237d5a40c75042123c19af"><div class="ttname"><a href="class_o_m_sim_decays_analysis.html#a78449c898f237d5a40c75042123c19af">OMSimDecaysAnalysis::writeThreadHitInformation</a></div><div class="ttdeci">void writeThreadHitInformation()</div><div class="ttdoc">Write data of the hits to the output file.</div><div class="ttdef"><b>Definition</b> OMSimDecaysAnalysis.cc:109</div></div>
<div class="ttc" id="aclass_o_m_sim_decays_analysis_html_aa111935e44e66f005b9b59a3ee5919e0"><div class="ttname"><a href="class_o_m_sim_decays_analysis.html#aa111935e44e66f005b9b59a3ee5919e0">OMSimDecaysAnalysis::reset</a></div><div class="ttdeci">void reset()</div><div class="ttdoc">Resets (deletes) decay and hits data.</div><div class="ttdef"><b>Definition</b> OMSimDecaysAnalysis.cc:148</div></div>
<div class="ttc" id="aclass_o_m_sim_event_action_html_a10298c7dff0337cec4ee06a25ca9c116"><div class="ttname"><a href="class_o_m_sim_event_action.html#a10298c7dff0337cec4ee06a25ca9c116">OMSimEventAction::EndOfEventAction</a></div><div class="ttdeci">void EndOfEventAction(const G4Event *)</div><div class="ttdoc">Custom actions at the end of the event.</div><div class="ttdef"><b>Definition</b> effective_area/src/OMSimEventAction.cc:8</div></div>
</div><!-- fragment --><p>As you can see, in case of multiplicity study, we need to merge the data, as we are looking for coincidences. In that case we have to merge: </p><div class="fragment"><div class="line"><span class="comment">//from radioactive_decays/OMSim_radioactive_decays.cc</span></div>
<div class="line">        <span class="keywordflow">if</span> (lArgs.get&lt;<span class="keywordtype">bool</span>&gt;(<span class="stringliteral">&quot;multiplicity_study&quot;</span>))</div>
<div class="line">        {</div>
<div class="line">            G4double coincidenceTimeWindow = lArgs.get&lt;<span class="keywordtype">double</span>&gt;(<span class="stringliteral">&quot;multiplicity_time_window&quot;</span>)*ns;</div>
<div class="line">            analysisManager.<a class="code hl_function" href="class_o_m_sim_decays_analysis.html#af747109a424e5878d2a4e42b6308f3cb">writeMultiplicity</a>(coincidenceTimeWindow);</div>
<div class="line">            analysisManager.<a class="code hl_function" href="class_o_m_sim_decays_analysis.html#aa111935e44e66f005b9b59a3ee5919e0">reset</a>();</div>
<div class="line">        }</div>
<div class="ttc" id="aclass_o_m_sim_decays_analysis_html_af747109a424e5878d2a4e42b6308f3cb"><div class="ttname"><a href="class_o_m_sim_decays_analysis.html#af747109a424e5878d2a4e42b6308f3cb">OMSimDecaysAnalysis::writeMultiplicity</a></div><div class="ttdeci">void writeMultiplicity(G4double pTimeWindow)</div><div class="ttdoc">Calls calculateMultiplicity and writes the results to the output file.</div><div class="ttdef"><b>Definition</b> OMSimDecaysAnalysis.cc:53</div></div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md24"></a>
Best Practices for Creating New Thread-Safe Containers</h1>
<p>When implementing new thread-safe containers in Geant4:</p>
<ol type="1">
<li><b>Use Thread-Local Storage</b>: <div class="fragment"><div class="line"><span class="comment">// Declare thread-local storage</span></div>
<div class="line">G4ThreadLocal <span class="keyword">static</span> YourDataType* threadLocalData = <span class="keyword">nullptr</span>;</div>
</div><!-- fragment --></li>
<li><b>Initialize on First Use</b>: <div class="fragment"><div class="line"><span class="keywordflow">if</span> (!threadLocalData) {</div>
<div class="line">    <span class="comment">// Initialize thread-local data only when first accessed</span></div>
<div class="line">    threadLocalData = <span class="keyword">new</span> YourDataType();</div>
<div class="line">}</div>
</div><!-- fragment --></li>
<li><b>Implement Data Merging (if necessary)</b>: <div class="fragment"><div class="line"><span class="keywordtype">void</span> mergeThreadData() {</div>
<div class="line">    G4AutoLock lock(&amp;m_mutex);  <span class="comment">// Ensure thread-safe access</span></div>
<div class="line">    <span class="comment">// Merge threadLocalData into a global container</span></div>
<div class="line">    <span class="comment">// This is where you combine data from all threads</span></div>
<div class="line">}</div>
</div><!-- fragment --></li>
<li><b>Ensure Proper Cleanup</b>: <div class="fragment"><div class="line"><span class="keywordtype">void</span> reset() {</div>
<div class="line">    <span class="comment">// Clean up thread-local data</span></div>
<div class="line">    <span class="keyword">delete</span> threadLocalData;</div>
<div class="line">    threadLocalData = <span class="keyword">nullptr</span>;</div>
<div class="line">}</div>
</div><!-- fragment --></li>
<li><b>Implement Thread-Safe Access</b>: Use mutex locks for shared resource access: <div class="fragment"><div class="line">G4AutoLock lock(&amp;m_mutex);  <span class="comment">// Protect access to shared resources</span></div>
<div class="line"><span class="comment">// Access or modify shared resources</span></div>
</div><!-- fragment --></li>
</ol>
<p>By following these guidelines and studying the provided examples, you can create thread-safe containers and classes for your Geant4 simulations, ensuring proper behavior in multi-threaded environments.</p>
<h1><a class="anchor" id="autotoc_md25"></a>
Troubleshooting Multi-threading Issues</h1>
<p>When developing new code with multi-threaded simulations in Geant4, you may encounter race conditions or other thread-related issues. Here's a general approach to diagnose and resolve these problems:</p>
<h2><a class="anchor" id="autotoc_md26"></a>
1. Use Valgrind Tools</h2>
<p>Valgrind provides powerful tools for detecting thread-related issues:</p>
<p>a) Helgrind: </p><div class="fragment"><div class="line">valgrind --log-file=&quot;output_helgrind.txt&quot; --tool=helgrind ./OMSim_* [arguments]</div>
</div><!-- fragment --><p>b) DRD (Data Race Detector): </p><div class="fragment"><div class="line">valgrind --log-file=&quot;output_helgrind.txt&quot; --tool=drd ./OMSim_* [arguments]</div>
</div><!-- fragment --><p>These tools can identify potential race conditions and other thread-related issues. </p>
<h2><a class="anchor" id="autotoc_md27"></a>
2. Analyse the Output</h2>
<ul>
<li>Review the Valgrind output carefully. Look for:</li>
<li>Data race warnings</li>
<li>Mutex-related issues</li>
<li>Potential deadlocks</li>
<li>Tip: Use an LLM (like ChatGPT) to help interpret complex error messages and suggest potential solutions.</li>
</ul>
<h2><a class="anchor" id="autotoc_md28"></a>
4. Modify and repeat</h2>
<ul>
<li>Once you identify the object/method causing the error, check if it's obviously not thread-safe and being shared during simulation.</li>
<li>For a deeper understanding, provide the complete class (header + source) to the LLM for more detailed guidance.</li>
<li>Make changes to address the identified issues.</li>
<li>Use Valgrind tools again to verify if the issues have been resolved. </li>
</ul>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated on Sun Feb 2 2025 16:04:05 for OMSim by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.8 </li>
  </ul>
</div>
</body>
</html>
